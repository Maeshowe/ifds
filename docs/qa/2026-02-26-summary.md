# QA Audit ‚Äî √ñsszes√≠t≈ë Dashboard

**Date:** 2026-02-26
**Auditor:** QA Layer (CC desktop.app)
**Baseline audit #1 ‚Äî first full run**

---

## Audit Coverage

| # | Audit | Report | CRITICAL | MEDIUM | STYLE |
|---|-------|--------|----------|--------|-------|
| 1 | Code Review | `2026-02-26-code-review.md` | 1 | 6 | 5 |
| 2 | Test Gap Analysis | `2026-02-26-test-gaps.md` | 11 | 32 | 12 |
| 3 | Pipeline Output | `2026-02-26-pipeline-output.md` | 2 | 9 | 3 |
| 4 | Doc Sync | `2026-02-26-doc-sync.md` | 2 | 9 | 5 |
| 5 | Pre-deploy Gate | `2026-02-26-pre-deploy.md` | 1 | 10 | 8 |
| | **TOTAL** | | **17** | **66** | **33** |

---

## TOP CRITICAL Findings ‚Äî Azonnali CC Task

### Production Risk (most fix)

| # | Finding | File | Audit |
|---|---------|------|-------|
| C1 | `asyncio.gather` without `return_exceptions=True` ‚Äî single Polygon 429 crashes Phase 1 | `phase1_regime.py:203` | Code Review |
| C2 | Circuit breaker warns but does NOT halt order submission | `submit_orders.py:211-215` | Pipeline Output |
| C3 | EOD PnL double-counting ‚Äî no idempotency guard | `eod_report.py:216-264` | Pipeline Output |
| C4 | deploy_daily.sh runs NO tests before deploy | `scripts/deploy_daily.sh` | Pre-deploy |
| C5 | `earnings_exclusion_days` = 5 in docs, 7 in code | PARAMETERS.md + PIPELINE_LOGIC.md | Doc Sync |

### Test Coverage Gaps (next sprint)

| # | Finding | What's untested | Audit |
|---|---------|----------------|-------|
| C6 | `BaseAPIClient._get()` retry logic | 429, 5xx, timeout, circuit breaker | Test Gaps |
| C7 | `AsyncBaseAPIClient._get()` retry + semaphore | Async retry, rate limiting, session lifecycle | Test Gaps |
| C8 | Short-selling bracket simulation | Fill, TP, stop, P&L ‚Äî ZERO tests for short path | Test Gaps |
| C9-C11 | HTTP error classification, timeout exhaustion | 4xx vs 5xx, requests.Timeout, asyncio.TimeoutError | Test Gaps |

---

## MEDIUM Highlights ‚Äî K√∂vetkez≈ë BC-be

### Code Quality
- F2: `PositionSizing` copy drops `mm_regime` + `unusualness_score` (OBSIDIAN data loss when BC17 activates)
- F3/F4: Hardcoded scoring values not in config (invisible to SIM-L2)
- F5: 9 silent `except Exception: pass` blocks without logging
- F8: `funda_score` unbounded while `flow_score` capped [0,100]

### Deploy Hardening
- No concurrent execution guard (flock) in deploy_daily.sh
- No Telegram alert on pipeline failure
- No state/ backup before each run
- Phase 2, 4, 6 non-atomic file writes

### Paper Trading
- IBKR commission MAX_FLOAT sentinel not checked
- Gross PnL excludes commissions
- nuke.py skips connection retry logic
- cumulative_pnl.json no file locking

### Config Validation
- OBSIDIAN regime multiplier keys not validated (runtime KeyError risk)

### Doc Sync
- PIPELINE_LOGIC.md stale (817 tests, missing 3+ features)
- `factor_volatility_window` listed in wrong config section

---

## Deduplicated Cross-Audit Findings

N√©h√°ny finding t√∂bb auditban is felbukkant:

| Finding | Appears in |
|---------|-----------|
| Circuit breaker non-halt | Pipeline Output (PT1) + Pre-deploy (F-10) |
| Phase 4 snapshot non-atomic write | Pipeline Output (PH1) + Pre-deploy (F-17) |
| EARN column string slice | Code Review (F11) + Pipeline Output (T2) |
| nuke.py hardcoded port | Pipeline Output (PT8) + Pre-deploy (F-09) |

---

## Consolidated CC Task List (priorit√°s szerinti)

### üî¥ Immediate (CRITICAL ‚Äî this week)
1. ‚òê `phase1_regime.py:203` ‚Äî add `return_exceptions=True` to asyncio.gather
2. ‚òê `submit_orders.py:211-215` ‚Äî circuit breaker must halt or require --override
3. ‚òê `eod_report.py:216-264` ‚Äî add idempotency guard (check date in history)
4. ‚òê `deploy_daily.sh` ‚Äî add pytest pre-flight before `python -m ifds run`
5. ‚òê PARAMETERS.md + PIPELINE_LOGIC.md ‚Äî fix `earnings_exclusion_days` 5‚Üí7

### üü° Before BC17 (MEDIUM ‚Äî next 1-2 weeks)
6. ‚òê Add `test_base_client.py` ‚Äî retry, 429, 5xx, timeout, circuit breaker
7. ‚òê Add `test_async_base_client.py` ‚Äî mirror + semaphore + session
8. ‚òê Add short-selling bracket sim tests
9. ‚òê `phase6_sizing.py` ‚Äî use `dataclasses.replace()` for PositionSizing copies
10. ‚òê `phase4_stocks.py` ‚Äî move hardcoded VWAP +5 and inst ownership scores to config
11. ‚òê `phase4_stocks.py:835` ‚Äî cap funda_score to [0, 100]
12. ‚òê Add logging to 9 silent exception blocks (especially phase5_gex.py)
13. ‚òê `deploy_daily.sh` ‚Äî add flock, Telegram failure alert, state/ backup
14. ‚òê PIPELINE_LOGIC.md ‚Äî update header (848 tests), add Danger Zone, EARN, Phase 2 breakdown
15. ‚òê `validator.py` ‚Äî validate OBSIDIAN regime multiplier keys

### üü¢ Backlog (STYLE ‚Äî when convenient)
16. ‚òê Phase 2/4/6 atomic file writes
17. ‚òê EventLogger lazy open
18. ‚òê time.monotonic() consistency
19. ‚òê Sync/async code dedup (~600 lines)
20. ‚òê Pin date.today() once in runner
21. ‚òê Strengthen 43 weak `is not None` test assertions
22. ‚òê API client unit tests (Polygon, FMP, FRED, UW)
23. ‚òê Paper trading: commission MAX_FLOAT check, absolute paths, exit codes
24. ‚òê CHANGELOG.md date range update
25. ‚òê .env.example cache config

---

## Visszacsatol√°si Loop

A k√∂vetkez≈ë QA fut√°s (terv: BC17 commit ut√°n) valid√°lja:
- ‚òê Mely CRITICAL-ok lettek jav√≠tva?
- ‚òê Nem keletkeztek-e √∫j regressions?
- ‚òê A jav√≠t√°sok fedettek-e teszttel?

---

## Verdict

**CONDITIONAL PASS** ‚Äî Az IFDS k√≥db√°zis √©rett √©s production-grade. A 17 CRITICAL finding k√∂z√ºl 5 azonnali beavatkoz√°st ig√©nyel (C1-C5), a t√∂bbi 12 a tesztel√©si hi√°nyoss√°gokra vonatkozik. A rendszer a jelenlegi √°llapotban m≈±k√∂dik, de a Phase 1 asyncio.gather bug (C1) √©s a circuit breaker non-halt (C2) val√≥s production kock√°zat.
