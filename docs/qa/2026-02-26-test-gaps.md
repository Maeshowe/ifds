# QA Audit — Test Gap Analysis

**Date:** 2026-02-26
**Auditor:** QA Layer (CC desktop.app)
**Scope:** tests/ vs src/ifds/ — stubs, untested modules, edge cases, mock quality, assertion quality
**Mode:** READ-ONLY
**Test count:** 848 tests, 0 failures, 0 warnings

---

## 1. Test Stubs

**Verdict: CLEAN** — No test functions containing only `pass` or `assert True`. All 848 tests contain substantive logic.

---

## 2. Untested Modules

| # | Source Module | Severity | Notes |
|---|---|---|---|
| 1 | `data/base.py` | **[CRITICAL]** | `BaseAPIClient._get()` retry logic, `health_check()`, circuit breaker integration — zero unit tests |
| 2 | `data/async_base.py` | **[CRITICAL]** | `AsyncBaseAPIClient._get()` semaphore, retry, aiohttp session — zero unit tests |
| 3 | `data/polygon.py` | [MEDIUM] | All methods untested (only manual `live_api_test_manual.py`) |
| 4 | `data/fmp.py` | [MEDIUM] | Only `get_next_earnings_date` tested. Screener, earnings calendar, etc. untested |
| 5 | `data/fred.py` | [MEDIUM] | `get_series`, `get_vix`, `get_tnx` — zero unit tests |
| 6 | `data/unusual_whales.py` | [MEDIUM] | All methods untested |
| 7 | `data/async_clients.py` | [MEDIUM] | Async variants only indirectly tested through phases |
| 8 | `data/async_adapters.py` | [MEDIUM] | Sync adapters tested, async not directly |
| 9 | `cli.py` | [MEDIUM] | Only indirectly via pipeline_e2e |
| 10 | `config/loader.py` | [MEDIUM] | File-based config loading, missing files, malformed YAML untested |
| 11 | `pipeline/runner.py` | [MEDIUM] | `_should_run()` completely untested |
| 12 | `sim/report.py` | [MEDIUM] | `print_validation_report()` zero tests |
| 13 | `scripts/paper_trading/*` | [MEDIUM] | submit_orders, close_positions, eod_report, nuke — zero tests |
| 14 | `config/validator.py` | [STYLE] | Tested via test_config but helpers lack direct tests |
| 15 | `output/console.py` | [STYLE] | Partially tested, many formatters lack content assertions |

---

## 3. Untested Public Functions in Key Modules

### 3.1 Phase modules

| Module | Untested Functions | Severity |
|---|---|---|
| phase0_diagnostics.py | `_check_circuit_breaker()` | [MEDIUM] |
| phase3_sectors.py | `_compute_pct_above_sma_n_days_ago()`, `_detect_breadth_divergence()`, `_apply_breadth_score_adjustment()` in isolation | [MEDIUM] |
| phase2_universe.py | `_save_universe_snapshot()` | [STYLE] |
| phase4_stocks.py | `_analyze_flow()` (network-calling wrapper) | [STYLE] |
| phase5_obsidian.py | `_compute_dex()`, `_compute_aggregate_iv()`, `_mean()`, `_std()` standalone | [STYLE] |
| phase6_sizing.py | `_join_stock_gex()` | [STYLE] |

### 3.2 Sim modules

| Module | Untested Functions | Severity |
|---|---|---|
| validator.py | `validate_execution_plans()` — main orchestrator | [MEDIUM] |
| replay.py | `run_comparison()` — Polygon-calling variant, `_fetch_bars_once()` | [MEDIUM] |
| report.py | `print_validation_report()` | [MEDIUM] |

---

## 4. Edge Case Gaps

### 4.1 Empty list/dict handling

| # | File | Gap | Severity |
|---|---|---|---|
| 1 | `data/obsidian_store.py` | `get_feature_series()` with empty entries | [MEDIUM] |
| 2 | `phases/phase3_sectors.py` | `_calculate_breadth()` with empty holdings | [MEDIUM] |
| 3 | `sim/comparison.py` | `compare_variants()` with empty variant list | [MEDIUM] |
| 4 | `sim/broker_sim.py` | `simulate_bracket_order()` with `daily_bars=[]` — unmodified trade assertion | [STYLE] |
| 5 | `output/telegram.py` | `_format_sector_table()` with empty sectors | [STYLE] |

### 4.2 None/null input handling

| # | File | Gap | Severity |
|---|---|---|---|
| 6 | `phases/phase4_stocks.py` | `_calculate_combined_score()` when `technical=None` or `flow=None` | [MEDIUM] |
| 7 | `data/adapters.py` | `_aggregate_dp_records()` with None volume fields | [MEDIUM] |
| 8 | `sim/broker_sim.py` | `simulate_bracket_order()` with `entry_price=0` | [MEDIUM] |
| 9 | `data/cache.py` | `FileCache.get()` with corrupted JSON on disk | [MEDIUM] |
| 10 | `output/telegram.py` | `send_daily_report()` when `ctx.phase6=None` (pipeline halted early) | [MEDIUM] |

### 4.3 Boundary values

| # | File | Gap | Severity |
|---|---|---|---|
| 11 | `sim/broker_sim.py` | `compute_qty_split(0)` — zero quantity | [MEDIUM] |
| 12 | `sim/broker_sim.py` | `simulate_bracket_order()` with `max_hold_days=0` | [MEDIUM] |
| 13 | `phases/phase4_stocks.py` | `_calculate_rsi()` with all identical close prices | [MEDIUM] |
| 14 | `phases/phase5_obsidian.py` | `_z_score()` with `std=0` — division by zero risk | [MEDIUM] |
| 15 | `phases/phase6_sizing.py` | `_calculate_multiplier_total()` producing extreme values | [MEDIUM] |
| 16 | `data/circuit_breaker.py` | `ProviderCircuitBreaker` with `window_size=1` | [STYLE] |

### 4.4 API error responses

| # | File | Gap | Severity |
|---|---|---|---|
| 17 | `data/base.py` | HTTP 429 retry behavior | **[CRITICAL]** |
| 18 | `data/base.py` | HTTP 500 retry vs HTTP 400 no-retry | **[CRITICAL]** |
| 19 | `data/base.py` | Connection timeout behavior | **[CRITICAL]** |
| 20 | `data/async_base.py` | Same as above for async | **[CRITICAL]** |
| 21 | `data/fmp.py` | `screener()` malformed JSON response | [MEDIUM] |
| 22 | `data/polygon.py` | `get_aggregates()` returning `{"results": null}` | [MEDIUM] |

### 4.5 Timeout scenarios

| # | File | Gap | Severity |
|---|---|---|---|
| 23 | `data/base.py` | `requests.Timeout` through retry cycle | **[CRITICAL]** |
| 24 | `data/async_base.py` | `asyncio.TimeoutError` in `_get()` | **[CRITICAL]** |
| 25 | `output/telegram.py` | `_send_message()` timeout | [MEDIUM] |

---

## 5. Mock Quality

### ✅ Positive
- No real API calls in automated tests — test API keys used
- `live_api_test_manual.py` properly separated from pytest discovery
- `requests.post` properly mocked in Telegram tests
- Async clients mocked with `MagicMock` and async returns

### Gaps

| # | Gap | Severity |
|---|---|---|
| 1 | `BaseAPIClient._get()` never mocked in isolation — all tests mock at higher level | **[CRITICAL]** |
| 2 | `AsyncBaseAPIClient._get()` never tested | **[CRITICAL]** |
| 3 | `_send_message()` in telegram.py always patched out | [MEDIUM] |
| 4 | No mock for corrupted/partial API responses | [MEDIUM] |

---

## 6. Assertion Quality

### Weak `is not None` patterns (43 instances)

| File | Concern | Improvement |
|---|---|---|
| `test_pipeline_e2e.py` | `ctx.diagnostics is not None`, `ctx.macro is not None`, etc. | Assert regime type, position count |
| `test_batch_darkpool.py` | `result is not None` (5×) | Assert `result["signal"]` value |
| `test_adapters.py` | `result is not None` (2×) | Assert expected keys present |
| `test_bc9_scoring.py` | `tech.rs_vs_spy is not None`, `flow.pcr is not None` (7×) | Assert value ranges |
| `test_bc14_breadth.py` | `result is not None`, `scores[0].breadth is not None` (4×) | Assert breadth in [0, 100] |

### ✅ Excellent assertion quality in:
- `test_sim_validator.py` — P&L with `pytest.approx()`
- `test_sim_replay.py` — paired t-test statistical significance
- `test_bc18_prep.py` — danger zone boundary values
- `test_bc15_obsidian.py` — z-score, regime, store persistence
- `test_phase6.py` — position sizing limits, multiple scenarios

---

## 7. Short Selling Coverage Gap

### Finding SS1 — [CRITICAL] Short-selling bracket simulation ZERO tests

`broker_sim.py` has explicit short-selling logic (lines 62-68, 97-102, 137-139):
- Short fill: `bar["h"] >= entry_price`
- Short P&L: `fill_price - exit_price`
- Short stop/TP direction

**All bracket sim tests use `direction="BUY"` only.** The entire short path is untested.

Note: `test_phase6.py` tests `SELL_SHORT` direction for position creation, but the bracket simulation path is the gap.

---

## Summary

| Severity | Count | Key Areas |
|----------|-------|-----------|
| **CRITICAL** | 11 | BaseAPIClient retry, AsyncBaseAPIClient retry/semaphore, short-selling bracket sim, HTTP error classification, timeout handling |
| **MEDIUM** | 32 | API client unit tests, edge cases (empty/None/boundary), paper trading scripts, `validate_execution_plans()`, `print_validation_report()` |
| **STYLE** | 12 | Weak assertions, console output tests, helper function isolation |
| **Total** | 55 | |

---

## Priority Task List for CC

### Immediate (CRITICAL — untested critical paths)
1. ☐ **Add `test_base_client.py`** — retry on timeout, 429, 5xx; no retry on 4xx; circuit breaker integration; health check
2. ☐ **Add `test_async_base_client.py`** — mirror all base tests + semaphore rate limiting + aiohttp session lifecycle
3. ☐ **Add short-selling bracket sim tests** — fill, TP hit, stop hit, same-day ambiguity, P&L calculation

### Next session (MEDIUM — API client coverage)
4. ☐ Add `test_polygon_client.py` — mock `_get()`, test each public method
5. ☐ Add `test_fmp_client.py` — mock `_get()`, test screener, earnings calendar, etc.
6. ☐ Add `test_fred_client.py` — mock `_get()`, test get_series, get_vix, get_tnx
7. ☐ Add `test_uw_client.py` — mock `_get()`, test dark pool, greeks

### Next session (MEDIUM — edge cases)
8. ☐ `compute_qty_split(0)` — zero quantity test
9. ☐ `_z_score()` with std=0 — division by zero test
10. ☐ `_calculate_rsi()` with flat prices
11. ☐ `FileCache.get()` with corrupted JSON
12. ☐ `compare_variants()` with empty variant list

### Backlog (MEDIUM)
13. ☐ `validate_execution_plans()` integration test with mocked Polygon
14. ☐ `print_validation_report()` test
15. ☐ Paper trading script tests (at minimum: `lib/orders.py`)
16. ☐ `_should_run()` in runner.py

### Backlog (STYLE)
17. ☐ Strengthen 43 weak `is not None` assertions
18. ☐ Add `_esc()` unit test for Telegram HTML escaping
